name: Build PX68K macOS (Japanese Encoding Safe)

env:
  # 强制 UTF-8，但允许 Japanese locale 回退
  LANG: C.UTF-8
  LC_ALL: C.UTF-8

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: macos-13
            arch: x86_64
          - runner: macos-14  
            arch: arm64
    
    steps:
    - name: Checkout with proper encoding
      uses: actions/checkout@v4
      with:
        # 关键：不要自动转换换行符（日本老项目可能是 CR+LF）
        # GitHub 默认处理换行符可能导致 Shift-JIS 文件损坏
        persist-credentials: false

    - name: Setup Japanese Environment
      run: |
        # Git 配置（防日文文件名乱码）
        git config --local core.quotepath false
        git config --local core.precomposeunicode true
        
        # 安装日文 locale（虽然可能用不到，但保险）
        if command -v locale-gen &> /dev/null; then
          sudo locale-gen ja_JP.UTF-8 || true
        fi
        
        # 检测关键文件编码
        echo "=== File Encoding Check ==="
        for f in readme.txt develop.txt version.txt; do
          [ -f "$f" ] && echo "$f: $(file -b $f)" || true
        done

    - name: Install dependencies
      run: |
        brew install sdl2 sdl2_gfx nkf  # nkf 用于编码转换
        
    - name: Handle Japanese Documentation
      run: |
        # 创建带 BOM 的 UTF-8 版本供 GitHub 显示，但保留原文件给构建系统
        for doc in readme.txt develop.txt; do
          if [ -f "$doc" ]; then
            # 检测是否为 Shift-JIS
            if nkf -g "$doc" | grep -q "Shift_JIS"; then
              echo "Converting $doc from Shift-JIS to UTF-8 for display"
              nkf -w "$doc" > "${doc}.utf8.txt"
            fi
          fi
        done

    - name: Build
      run: |
        # 确保编译器不会日文注释报错
        make -f Makefile.macos SDL2=1 -j4 \
          EXTRA_CFLAGS="-Wno-invalid-source-encoding" || \
        make -f Makefile.macos SDL2=1 -j4  # 如果失败尝试不加额外参数
        
    - name: Artifact with Japanese-safe naming
      uses: actions/upload-artifact@v4
      with:
        name: "PX68K-${{ matrix.arch }}-macOS"
        # 如果包含日文 ROM 测试文件，需要确保路径处理正确
        path: |
          px68k
          *.txt
          !*.bak
