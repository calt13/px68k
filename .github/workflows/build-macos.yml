name: Build PX68K macOS (Japanese Encoding Safe)

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # 手动触发按钮

env:
  MACOSX_DEPLOYMENT_TARGET: "13.0"
  # 处理日文文件名和文本
  LANG: C.UTF-8
  LC_ALL: C.UTF-8

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: macos-13
          - arch: arm64
            runner: macos-14

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout with proper encoding
        uses: actions/checkout@v4

      - name: Setup Japanese Environment & Git Config
        run: |
          # 防止日文文件名乱码 (が vs が 问题)
          git config --local core.quotepath false
          git config --local core.precomposeunicode true
          git config --local core.ignorecase false

          # 安装编码检测工具 (nkf = Network Kanji Filter)
          brew install nkf

      - name: Check File Encodings
        run: |
          echo "=== Checking Japanese Documentation Encoding ==="
          for f in readme.txt develop.txt; do
            if [ -f "$f" ]; then
              enc=$(nkf -g "$f" 2>/dev/null || echo "UNKNOWN")
              echo "$f: $enc"
              # 如果是 Shift-JIS，创建 UTF-8 副本供 GitHub 显示
              if [ "$enc" = "Shift_JIS" ] || [ "$enc" = "ISO-2022-JP" ]; then
                echo "  Converting $f to UTF-8 for artifact packaging..."
                nkf -w "$f" > "$f.utf8.txt"
              fi
            fi
          done

      - name: Install Dependencies
        run: |
          brew install sdl2 sdl2_gfx make pkg-config

      - name: Prepare version file
        run: |
          if [ ! -f version.txt ]; then
            echo "PX68K_VERSION=0.15" > version.txt
          fi

      - name: Build (${{ matrix.arch }})
        run: |
          # 添加 -Wno-invalid-source-encoding 防止日文注释警告
          make -f Makefile.macos SDL2=1 -j4 \
            CDEBUGFLAGS_EXTRA="-Wno-invalid-source-encoding"

      - name: Ad-hoc codesign
        run: codesign --force --sign - px68k

      - name: Package Artifact
        run: |
          mkdir -p "PX68K-${{ matrix.arch }}"
          cp px68k "PX68K-${{ matrix.arch }}/"

          # 复制文档（优先 UTF-8 版本，回退到原始文件）
          for f in readme.txt develop.txt; do
            if [ -f "$f.utf8.txt" ]; then
              cp "$f.utf8.txt" "PX68K-${{ matrix.arch }}/$f"
            elif [ -f "$f" ]; then
              cp "$f" "PX68K-${{ matrix.arch }}/"
            fi
          done

          # 创建日文说明
          cat > "PX68K-${{ matrix.arch }}/README_BUILD.txt" << EOF
          PX68K ${{ matrix.arch }} build for macOS

          设置方法:
          1. mkdir -p ~/.keropi
          2. Copy BIOS files (iplrom.dat, cgrom.dat) to ~/.keropi/
          3. ./px68k

          注意: 原readme.txt为Shift-JIS编码，此处已转换为UTF-8
          EOF

          zip -r "PX68K-${{ matrix.arch }}.zip" "PX68K-${{ matrix.arch }}/"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PX68K-${{ matrix.arch }}
          path: PX68K-${{ matrix.arch }}.zip
          retention-days: 30
