name: Build PX68K Linux x64

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/build.yml') }}
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libsdl2-dev libsdl2-gfx-dev nkf
      
      - name: Verify source structure
        run: |
          echo "=== Checking m68000 structure ==="
          ls -la m68000/
          test -f m68000/c68k.c && echo "✓ m68000/c68k.c exists" || echo "✗ missing"
          test -f m68000/m68000.c && echo "✓ m68000/m68000.c exists" || echo "✗ missing"
      
      - name: Fix Makefile for 64-bit
        run: |
          # 1. 移除 -m32（关键：原 Makefile 在非 armv6l 时强制使用 -m32）
          sed -i 's/MOPT= -m32/MOPT=/' Makefile
          
          # 2. 禁用所有警告避免 GCC 14 阻断
          sed -i 's/-Wall/-w/g' Makefile
          
          # 3. 启用 SDL2（原 Makefile 通过 SDL2=1 变量控制）
          echo "Will build with: make SDL2=1"
      
      - name: Prepare version file
        run: |
          [ ! -f version.txt ] && echo "PX68K_VERSION=0.15" > version.txt
      
      - name: Build
        run: make SDL2=1 -j$(nproc)
      
      - name: Package
        run: |
          mkdir -p px68k-linux
          cp px68k px68k-linux/
          cp readme.txt develop.txt px68k-linux/ 2>/dev/null || true
          tar czvf px68k-linux-x64.tar.gz px68k-linux/
      
      - uses: actions/upload-artifact@v4
        with:
          name: px68k-linux-x64
          path: px68k-linux-x64.tar.gz
