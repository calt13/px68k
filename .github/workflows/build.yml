name: Build PX68K

on: [push, pull_request]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsdl2-dev libsdl2-gfx-dev
      
      - name: Fix (4行sed)
        run: |
          # 1. 修改 windows.h：给 max 宏加上 NOMINMAX 保护
          sed -i '/#define max(a,b)/i #ifndef NOMINMAX' win32api/windows.h
          
          # 2. 修改 windows.h：给 min 宏加上 #endif（闭合上面的 #ifndef）
          sed -i '/#define min(a,b)/a #endif' win32api/windows.h
          
          # 3. Makefile 移除 -m32
          sed -i 's/MOPT= -m32/MOPT=/' Makefile
          
          # 4. Makefile 添加 -DNOMINMAX 和 GCC 14 宽容选项
          sed -i 's/CDEBUGFLAGS = -g -O0 -fno-strict-aliasing/CDEBUGFLAGS = -g -O0 -fno-strict-aliasing -fpermissive -Wno-error -DNOMINMAX/' Makefile
      
      - name: Build
        run: make SDL2=1
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: px68k-linux-x64
          path: px68k
   
      - name: Build
        run: make SDL2=1
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: px68k-macos-x64
          path: px68k
