name: Build PX68K

on: [push, pull_request]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsdl2-dev libsdl2-gfx-dev
      
      - name: Fix Makefile (2行sed)
        run: |
          # 1. 移除 -m32（支持64位）
          sed -i 's/MOPT= -m32/MOPT=/' Makefile
          
          # 2. GCC 14兼容（解决windraw.c指针转换错误）
          sed -i 's/CDEBUGFLAGS = -g -O0 -fno-strict-aliasing/CDEBUGFLAGS = -g -O0 -fno-strict-aliasing -fpermissive -Wno-error -Wno-format-security -Wno-int-conversion -Wno-incompatible-pointer-types/' Makefile
      
      - name: Build
        run: make SDL2=1
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: px68k-linux-x64
          path: px68k

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: brew install sdl2 sdl2_gfx
      
      - name: Fix Makefile (macOS版，只有sed -i区别)
        run: |
          sed -i '' 's/MOPT= -m32/MOPT=/' Makefile
          sed -i '' 's/CDEBUGFLAGS = -g -O0 -fno-strict-aliasing/CDEBUGFLAGS = -g -O0 -fno-strict-aliasing -fpermissive -Wno-error -Wno-format-security -Wno-int-conversion -Wno-incompatible-pointer-types/' Makefile
      
      - name: Build
        run: make SDL2=1
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: px68k-macos-x64
          path: px68k
