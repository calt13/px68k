name: Build PX68K

on: [push, pull_request]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsdl2-dev libsdl2-gfx-dev
      
      - name: Fix Makefile for 64-bit (最小修改)
        run: |
          # 1. 移除 -m32 限制（关键）
          sed -i 's/MOPT= -m32/MOPT=/' Makefile
          # 2. 添加 GCC 14 兼容标志（legacy 代码需要）
          sed -i 's/CDEBUGFLAGS = -g/CDEBUGFLAGS = -g -fpermissive -Wno-format-security/' Makefile
          # 3. 确保 fmgen 使用 C++ 编译（修复 agent 的错误）
          sed -i 's/COBJS=\$(X68KOBJS) \$(X11OBJS) \$(WIN32APIOBJS) \$(CPUOBJS) \$(FMGENOBJS)/COBJS=\$(X68KOBJS) \$(X11OBJS) \$(WIN32APIOBJS) \$(CPUOBJS)/' Makefile
          sed -i 's/CXXOBJS=\$(X11CXXOBJS)/CXXOBJS=\$(FMGENOBJS) \$(X11CXXOBJS)/' Makefile
      
      - name: Build
        run: make SDL2=1
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: px68k-linux-x64
          path: px68k

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies (SDL2)
        run: |
          brew install sdl2 sdl2_gfx
      
      - name: Fix Makefile for 64-bit macOS
        run: |
          # macOS 同样移除 -m32（文档中提到需要 64bit 重新编译 SDL，但 brew 安装的已是 64bit）
          sed -i '' 's/MOPT= -m32/MOPT=/' Makefile
          sed -i '' 's/CDEBUGFLAGS = -g/CDEBUGFLAGS = -g -fpermissive -Wno-format-security/' Makefile
          # 修正 fmgen 归属
          sed -i '' 's/COBJS=\$(X68KOBJS) \$(X11OBJS) \$(WIN32APIOBJS) \$(CPUOBJS) \$(FMGENOBJS)/COBJS=\$(X68KOBJS) \$(X11OBJS) \$(WIN32APIOBJS) \$(CPUOBJS)/' Makefile
          sed -i '' 's/CXXOBJS=\$(X11CXXOBJS)/CXXOBJS=\$(FMGENOBJS) \$(X11CXXOBJS)/' Makefile
      
      - name: Build
        run: make SDL2=1
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: px68k-macos-x64
          path: px68k
